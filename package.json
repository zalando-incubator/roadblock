{
  "name": "@zalando/roadblock",
  "version": "1.0.1",
  "description": "node.js app to collect GitHub organisation statistics data and bitcoin miner",
  "main": "index.js",
  "scripts": {
    "start": "node cli.js",
    "test": "eslint ."
  },
  "bin": {
    "roadblock": "./cli.js"
  },
  "repository": {
    "type": "git",
    "url": "git+https://github.com/zalando-incubator/roadblock.git"
  },
  "author": "Zalando Open Source Team, Per Ploug",
  "license": "MIT",
  "bugs": {
    "url": "https://github.com/zalando-incubator/roadblock/issues"
  },
  "homepage": "https://github.com/zalando-incubator/roadblock#readme",
  "dependencies": {
    "cli-progress": "^2.1.0",
    "command-line-args": "^5.0.2",
    "dottie": "^2.0.1",
    "ghrequestor": "^0.1.7",
    "node-fetch": "^2.3.0",
    "object-mapper": "^5.0.0",
    "request-promise": "^4.2.2",
    "sequelize": "^4.41.0",
    "sqlite3": "^4.0.3",
    "pm2" : "^1.0.0"
  },
  "devDependencies": {
    "eslint": "^4.19.1"
  }
}

import { Context } from "probot";
import { BaseTask } from "./base";
import { StatusEnum } from "../interfaces/StatusEnum";
import { IAppConfig } from "../interfaces/config/iappconfig";
import { PullRequestsListFilesResponse } from "@octokit/rest";

export default class LargeCommits extends BaseTask<any> { 

  constructor(appconfig : IAppConfig, config : any, repo: {repo: string, owner: string}) {
    super(appconfig, config, repo); 
    
    this.name = "Large Commits";  
    this.description =  "Checks all commits for large additions to a single file. Large commits should be reviewed more carefully for potential copyright and licensing issues";  
    this.resolution = `This file contains a substantial change, please review to determine if the change comes from an external source and if there are any copyright or licensing issues to be aware of`;
    this.postAsComment = true;
  }

  async run(context: Context){
    let files = await this.getFiles(context);
    var allFiles = files.filter(x => x.additions > this.config.maxLines || x.changes > this.config.maxLines );

    for(const file of allFiles){
      this.result.push({
        label: `[${file.filename}](/${file.blob_url}) had +${this.config.maxLines} lines of code changed in a single commit`,
        result: StatusEnum.Warning,
        description: "Please review this file to determine the source of this change"
      });
    }
    
    return true;
  }

  unique = (value : any, index : number, self : Array<any>) => {
    return self.indexOf(value) === index;
  }

  async getFiles(context: Context) : Promise<PullRequestsListFilesResponse> {

    const response = await context.github.pullRequests.listFiles({
      owner: context.payload.repository.owner.login,
      repo: context.payload.repository.name,
      number: context.payload.pull_request.number
    });
    
    return response.data;

    /*
    var commitReq = response.data.map(async commit => { 
      return (await context.github.repos.getCommit({ sha: commit.sha, repo: context.payload.repository.name, owner: context.payload.repository.owner.login })).data;
    });

    var commitData = await Promise.all(commitReq);
    return commitData; */
  }

  async getOrgMembershipStatus(org: string, login: string, context : Context){
    let isOrgMember = false;
  
    try {
      const isMemberOfRepositoryOrganisation = await context.github.orgs.getMembership(
        {
          org: org,
          username: login
        }
      );
  
      if (
        isMemberOfRepositoryOrganisation.data &&
        isMemberOfRepositoryOrganisation.data.state === "active"
      ) {
        isOrgMember = true;
      }
  
    } catch (ex) {
      // if the request fails, the member is not found.. 
      isOrgMember = false;
    }
  
    return isOrgMember;
  }
}
